{% assign ns = 'cap-' | append: section.id %}

<section class="{{ ns }}-section">
  <div class="{{ ns }}-container">
    {% if section.settings.heading != blank %}
      <h2 class="{{ ns }}-heading">{{ section.settings.heading }}</h2>
    {% endif %}

    <div class="{{ ns }}-grid">
      {% for block in section.blocks %}
        {% assign col = block.settings.collection %}
        {% assign limit = block.settings.limit | default: 4 %}

        <details class="{{ ns }}-col" {% if forloop.first %}open{% endif %} {{ block.shopify_attributes }}>
          <summary class="{{ ns }}-col-head">
            <span class="{{ ns }}-col-title">
              {{ block.settings.title | default: col.title | default: 'Collection' }}
            </span>
            <span class="{{ ns }}-chev" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                <path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
          </summary>

          <div class="{{ ns }}-list">
            {% if col %}
              {% for product in col.products limit: limit %}
                <a class="{{ ns }}-item" href="{{ product.url }}" aria-label="{{ product.title | escape }}">
                  <div class="{{ ns }}-thumb">
                    {% if product.featured_image %}
                      <img
                        src="{{ product.featured_image | image_url: width: 120, height: 120, crop: 'center' }}"
                        alt="{{ product.title | escape }}"
                        loading="lazy"
                        width="60" height="60">
                    {% else %}
                      <div class="{{ ns }}-ph">No image</div>
                    {% endif %}
                  </div>
                  <div class="{{ ns }}-meta">
                    <div class="{{ ns }}-title">{{ product.title }}</div>
                    <div class="{{ ns }}-price">{{ product.price | money_without_trailing_zeros }}</div>
                  </div>
                </a>
                {% unless forloop.last %}
                  <div class="{{ ns }}-rule" aria-hidden="true"></div>
                {% endunless %}
              {% endfor %}
            {% else %}
              <div class="{{ ns }}-empty">Assign a collection</div>
            {% endif %}
          </div>
        </details>
      {% endfor %}
    </div>
  </div>

  <style>
    .{{ ns }}-section{padding:36px 0}
    .{{ ns }}-container{max-width:1300px;margin:0 auto;padding:0;}
    .{{ ns }}-heading{margin:0 0 24px;font-size:clamp(22px,2.6vw,30px);line-height:1.2;font-weight:600}

    /* GRID (desktop) */
    .{{ ns }}-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:40px}
    @media (max-width: 1200px){ .{{ ns }}-grid{gap:28px} }
    @media (max-width: 989px){ .{{ ns }}-grid{grid-template-columns:1fr;gap:10px} }

    /* Column wrapper uses <details> so it becomes accordion on mobile */
    .{{ ns }}-col{border-radius:10px;background:transparent}
    .{{ ns }}-col-head{list-style:none;cursor:default;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:0}
    .{{ ns }}-col-head::-webkit-details-marker{display:none}
    .{{ ns }}-col-title{font-size:clamp(18px,2.2vw,24px);font-weight:400; color: #000;}

    /* Chevron only visible on mobile */
    .{{ ns }}-chev{display:none;color:#111}
    @media (max-width: 989px){
      .{{ ns }}-chev{display:inline-flex;transform:rotate(0deg);transition:transform .2s ease}
      .{{ ns }}-col[open] .{{ ns }}-chev{transform:rotate(180deg)}
      .{{ ns }}-col-head{padding:10px 0}
      .{{ ns }}-container{padding:0 20px;}
    }

    /* List */
    .{{ ns }}-list{margin-top:12px}
    @media (min-width: 990px){
      /* On desktop, always show content (ignore open/closed) */
      .{{ ns }}-list{display:block}
    }
    @media (max-width: 989px){
      /* On mobile, only show when open */
      .{{ ns }}-col:not([open]) .{{ ns }}-list{display:none}
      .{{ ns }}-list{padding-left:0}
    }

    /* Item row */
    .{{ ns }}-item{
      display:grid;grid-template-columns:60px 1fr;gap:14px;
      text-decoration:none;color:inherit;padding:12px 0
    }
    .{{ ns }}-thumb{width:60px;height:60px;border-radius:8px;overflow:hidden;background:#f5f5f5;display:grid;place-items:center}
    .{{ ns }}-thumb img{width:100%;height:100%;object-fit:contain;display:block}
    .{{ ns }}-ph{font-size:11px;color:#888}
    .{{ ns }}-meta{display:flex;flex-direction:column;gap:6px}
    .{{ ns }}-title{
      font-size:14px;line-height:1.3;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;overflow:hidden;
      max-height:calc(1.3em * 2)
    }
    .{{ ns }}-price{font-weight:600;font-size:16px; color: #000;}

    .{{ ns }}-rule{height:1px;background:#e8e8e8;margin:0 0 0 0; width:100%}

    /* Desktop column divider line below title (visual match) */
    @media (min-width: 990px){
      .{{ ns }}-list{border-top:2px solid #ececec;padding-top:16px}
    }

    /* Mobile visual spacing */
    @media (max-width: 989px){
      .{{ ns }}-list{border-top:1px solid #eaeaea;margin-top:8px}
    }

    /* --- Product row dividers --- */
    .{{ ns }}-list > .{{ ns }}-item{border-bottom:1px solid #e8e8e8}
    .{{ ns }}-list > .{{ ns }}-item:last-of-type{border-bottom:none}
    .{{ ns }}-rule{display:none}

    /* --- NEW: Mobile divider between accordion blocks (last has none) --- */
    @media (max-width: 989px){
      .{{ ns }}-grid > .{{ ns }}-col{border-bottom:1px solid #eaeaea; padding-bottom:8px}
      .{{ ns }}-grid > .{{ ns }}-col:last-child{border-bottom:none}
    }
  </style>

  <script>
    // Desktop: keep all columns open. Mobile: only one open at a time.
    (function(){
      var root=document.currentScript.closest('section');
      if(!root) return;

      function isMobile(){ return window.matchMedia('(max-width: 989px)').matches; }

      function applyOpenState(){
        var mobile = isMobile();
        var details = root.querySelectorAll('details');
        details.forEach(function(d, idx){
          if(!mobile){
            d.setAttribute('open',''); // force open on desktop
          }else{
            // keep only first open by default
            if(idx === 0){ d.setAttribute('open',''); }
            else{ d.removeAttribute('open'); }
          }
        });
      }

      // Ensure exclusive open on mobile
      function attachExclusive(){
        root.querySelectorAll('details').forEach(function(d){
          d.addEventListener('toggle', function(){
            if(!isMobile() || !this.open) return;
            root.querySelectorAll('details').forEach(function(other){
              if(other !== d){ other.removeAttribute('open'); }
            });
          });
        });
      }

      applyOpenState();
      attachExclusive();
      window.addEventListener('resize', applyOpenState);
    })();
  </script>
</section>

{% schema %}
{
  "name": "Collections Accordion",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Don't Miss Our Products" }
  ],
  "blocks": [
    {
      "type": "col",
      "name": "Column",
      "settings": [
        { "type": "collection", "id": "collection", "label": "Collection" },
        { "type": "text", "id": "title", "label": "Title (optional)" },
        { "type": "range", "id": "limit", "label": "Products to show", "min": 1, "max": 8, "step": 1, "default": 4 }
      ]
    }
  ],
  "max_blocks": 4,
  "presets": [
    { "name": "Collections Accordion", "blocks": [ { "type": "col" }, { "type": "col" }, { "type": "col" }, { "type": "col" } ] }
  ]
}
{% endschema %}
