{% assign ns = 'phase-' | append: section.id %}

<section class="{{ ns }}-section" data-section-id="{{ section.id }}">
  <div class="{{ ns }}-container">
    {% if section.settings.heading != blank %}
      <h2 class="{{ ns }}-heading">{{ section.settings.heading }}</h2>
    {% endif %}

    <div class="{{ ns }}-wrap">
      <div class="{{ ns }}-track">
        {% for block in section.blocks %}
          {% assign col = block.settings.collection %}
          {% assign link_url = col.url | default: block.settings.link %}
          {% assign cover = block.settings.image | default: col.image %}
          {% if cover == blank and col and col.products_count > 0 %}
            {% assign cover = col.products.first.featured_image %}
          {% endif %}

          {%- comment -%}
            Per-block visual controls â†’ CSS variables
          {%- endcomment -%}
          {% assign _cta_bg   = block.settings.cta_bg   | default: '#ffffff' %}
          {% assign _cta_text = block.settings.cta_text | default: '#111111' %}
          {% assign _ov_col   = block.settings.overlay_color | default: '#000000' %}
          {% assign _ov_pct   = block.settings.overlay_strength | default: 55 %}
          {% assign _ov_alpha = _ov_pct | divided_by: 100.0 %}
          {% assign _ov_rgba  = _ov_col | color_modify: 'alpha', _ov_alpha %}
          {% assign _gray     = block.settings.grayscale | default: 0 %}

          {% if link_url != blank %}
            <a class="{{ ns }}-card"
               href="{{ link_url }}"
               {{ block.shopify_attributes }}
               style="--cta-bg: {{ _cta_bg }}; --cta-color: {{ _cta_text }}; --overlay-rgba: {{ _ov_rgba }}; --gray: {{ _gray }}%;">
          {% else %}
            <div class="{{ ns }}-card {{ ns }}-card--nolink"
                 {{ block.shopify_attributes }}
                 style="--cta-bg: {{ _cta_bg }}; --cta-color: {{ _cta_text }}; --overlay-rgba: {{ _ov_rgba }}; --gray: {{ _gray }}%;">
          {% endif %}
              {% if cover %}
                <img class="{{ ns }}-img" src="{{ cover | image_url: width: 1400 }}" alt="{{ block.settings.alt | default: block.settings.title | default: col.title | escape }}" loading="lazy">
              {% else %}
                <div class="{{ ns }}-ph">Add an image</div>
              {% endif %}

              <!-- Overlay -->
              <span class="{{ ns }}-shade" aria-hidden="true"></span>

              <div class="{{ ns }}-label">
                <span class="{{ ns }}-title">{{ block.settings.title | default: col.title }}</span>
                {% if block.settings.cta_label != blank %}
                  <span class="{{ ns }}-cta">{{ block.settings.cta_label }}</span>
                {% endif %}
              </div>
          {% if link_url != blank %}
            </a>
          {% else %}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
    <!-- Mobile-only progress thumb -->
      <div class="nf-progress"></div> 
  </div>
  <style>
    .{{ ns }}-section{
      padding:40px 0;
      /* overlay strength defaults (kept; overridden per-block via --overlay-rgba) */
      --ov1: .22;  /* top */
      --ov2: .55;  /* bottom */
    }
    .{{ ns }}-container{max-width:1300px;margin:0 auto;padding:0}
    .{{ ns }}-heading{margin:0 0 20px;font-size:clamp(22px,2.5vw,30px);font-weight:600;line-height:1.15}

    /* --- Layout --- */
    :root{ --{{ ns }}-gap: 28px; }
    .{{ ns }}-wrap{position:relative}
    .{{ ns }}-track{display:grid; grid-template-columns:repeat(4, 1fr); gap:var(--{{ ns }}-gap)}

    /* Card */
    .{{ ns }}-card{
      position:relative; display:block; border-radius:16px; overflow:hidden;
      height:280px; background:#f2f2f2; text-decoration:none; color:inherit;
      transition:transform .18s ease;
    }
    .{{ ns }}-card:hover{ transform:translateY(-2px) }
    .{{ ns }}-card.--nolink{ cursor:default }
    /* NEW: grayscale via per-block CSS var */
    .{{ ns }}-img{
      width:100%; height:100%; object-fit:cover; display:block;
      filter:saturate(.95) grayscale(var(--gray, 0%));
    }

    .{{ ns }}-ph{height:100%;display:grid;place-items:center;color:#777;background:linear-gradient(180deg,#fafafa,#f1f1f1)}

    /* Overlay layer (uses per-block rgba var; non-blocking) */
    .{{ ns }}-shade{
      position:absolute; inset:0; border-radius:inherit;
      background:linear-gradient(180deg, var(--overlay-rgba, rgba(0,0,0,var(--ov1))) 0%, var(--overlay-rgba, rgba(0,0,0,var(--ov2))) 100%);
      pointer-events:none;
    }

    .{{ ns }}-label{
      position:absolute; left:20px; right:20px; bottom:16px;
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
      color:#fff; font-weight:800;
      text-shadow:0 2px 12px rgba(0,0,0,.35)
    }
    .{{ ns }}-title{ font-size:clamp(18px,2.1vw,22px); line-height:1.2 }

    /* NEW: CTA pill uses per-block colors; hide automatically if no label */
    .{{ ns }}-cta{
      display:inline-block; padding:6px 16px; border-radius:6px;
      background:var(--cta-bg, #ffffff); color:var(--cta-color, #111111);
      font-weight:800; font-size:14px; line-height:1;
      box-shadow:0 8px 20px rgba(0,0,0,.25);
    }

    /* --- Mobile: horizontal scroll, show 1.5 cards --- */
    @media (max-width:989px){
      .{{ ns }}-track{
        display:flex; gap:16px;
        overflow-x:auto; -webkit-overflow-scrolling:touch;
        scroll-snap-type:x mandatory; padding-bottom:8px;
      }
      .{{ ns }}-container{padding:0 10px}

      /* 1.5 cards: choose a width ~66vw so the next ~33vw is visible */
      .{{ ns }}-card{
        flex:0 0 78vw;
        height:56vw; min-height:260px;
        scroll-snap-align:start;
      }
    }
  </style>
</section>

{% schema %}
{
  "name": "Shop by Phase",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Shop by Phase" }
  ],
  "blocks": [
    {
      "type": "phase",
      "name": "Phase",
      "settings": [
        { "type": "text", "id": "title", "label": "Title", "default": "Newborn (0 - 9m)" },
        { "type": "collection", "id": "collection", "label": "Link to collection" },
        { "type": "url", "id": "link", "label": "Or custom link (optional)" },
        { "type": "image_picker", "id": "image", "label": "Image (optional)" },
        { "type": "text", "id": "alt", "label": "Alt text (optional)" },

        { "type": "header", "content": "Visual overrides" },
        { "type": "text",  "id": "cta_label",       "label": "CTA label (optional)" },
        { "type": "color", "id": "cta_bg",          "label": "Button background", "default": "#ffffff" },
        { "type": "color", "id": "cta_text",        "label": "Button text color", "default": "#111111" },
        { "type": "color", "id": "overlay_color",   "label": "Overlay color",     "default": "#000000" },
        { "type": "range", "id": "overlay_strength","label": "Overlay opacity (%)", "min": 0, "max": 90, "step": 5, "unit": "%", "default": 55 },
        { "type": "range", "id": "grayscale",       "label": "Image grayscale (%)", "min": 0, "max": 100, "step": 10, "unit": "%", "default": 0 }
      ]
    }
  ],
  "max_blocks": 12,
  "presets": [
    {
      "name": "Shop by Phase",
      "blocks": [
        { "type": "phase" },
        { "type": "phase" },
        { "type": "phase" },
        { "type": "phase" }
      ]
    }
  ]
}
{% endschema %}
<script>
(function(){
  var root  = document.querySelector('.{{ ns }}-section');
  if(!root) return;

  var track = root.querySelector('.{{ ns }}-track');
  var thumb = root.querySelector('.nf-progress');   // your blue bar

  function isMobile(){ return window.innerWidth <= 989; }

  /* ---------- Hide native scrollbar on mobile & drive nf-progress ---------- */

  // Inject once: utility CSS that hides native scrollbars when we add the class
  (function ensureNoScrollbarCSS(){
    var id = '{{ ns }}-no-scrollbar-style';
    if(document.getElementById(id)) return;
    var s = document.createElement('style');
    s.id = id;
    s.textContent = `
      .{{ ns }}-track.no-native-scrollbar{ scrollbar-width: none; }
      .{{ ns }}-track.no-native-scrollbar::-webkit-scrollbar{ display: none; }
    `;
    document.head.appendChild(s);
  })();

  function toggleMobileUI(){
    if(!track || !thumb) return;

    if(isMobile()){
      // enable horizontal scroll but hide native bar, show our thumb
      track.classList.add('no-native-scrollbar');
      thumb.style.display = 'block';
    }else{
      // desktop: no custom thumb, show grid without native bar anyway
      track.classList.remove('no-native-scrollbar');
      thumb.style.transform = 'translateX(0)';
      thumb.style.display = ''; // let CSS handle default (usually hidden on desktop)
    }
  }

  function moveThumb(){
    if(!track || !thumb) return;

    if(!isMobile()){
      thumb.style.transform = 'translateX(0)';
      return;
    }

    var barWidth  = thumb.offsetWidth || 70;  // assume your CSS sets width: 70px
    var viewW     = track.clientWidth;        // viewport width of the scroll area
    var contentW  = track.scrollWidth;        // total scrollable content width
    var maxScroll = Math.max(1, contentW - viewW);
    var ratio     = Math.min(1, Math.max(0, track.scrollLeft / maxScroll));

    var travel = Math.max(0, viewW - barWidth);
    var x = ratio * travel;

    thumb.style.transform = 'translateX(' + x + 'px)';
  }

  // Bind once
  if(track && !track.dataset.nfProgressBound){
    track.addEventListener('scroll', moveThumb, { passive:true });

    // Recalculate after images load (they can change widths)
    track.querySelectorAll('img').forEach(function(img){
      if(!img.complete){
        img.addEventListener('load', function(){
          requestAnimationFrame(function(){ moveThumb(); });
        }, { once:true });
      }
    });

    track.dataset.nfProgressBound = '1';
  }

  // Handle resizes/breakpoints
  function onResize(){
    toggleMobileUI();
    requestAnimationFrame(moveThumb);
  }
  window.addEventListener('resize', onResize, { passive:true });

  // Init
  toggleMobileUI();
  requestAnimationFrame(moveThumb);
})();
</script>
