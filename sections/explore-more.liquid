{% comment %}
  Explore More – responsive card carousel
  - Desktop: show N cards (arrows only if there are more than N)
  - Mobile: 1 card per view, swipeable, nf-progress (moving thumb like trending)
{% endcomment %}

{% assign ns = 'explore-' | append: section.id %}

<section class="{{ ns }} section-{{ section.id }}">
  <div class="{{ ns }}__inner page-width">
    {% if section.settings.title != blank %}
      <h2 class="{{ ns }}__title">{{ section.settings.title }}</h2>
    {% endif %}

    <!-- Carousel -->
    <div class="{{ ns }}__shell"
         data-cols-desktop="{{ section.settings.cols_desktop | default: 4 }}"
         data-cols-mobile="{{ section.settings.cols_mobile | default: 1 }}">
      <button class="{{ ns }}__arrow prev" type="button" aria-label="Previous" hidden>←</button>

      <div class="{{ ns }}__viewport">
        <div class="{{ ns }}__track">
          {% for block in section.blocks %}
            {% assign link_url = '' %}
            {% if block.settings.button_url != blank %}
              {% assign link_url = block.settings.button_url %}
            {% elsif block.settings.button_product != blank %}
              {% assign link_url = block.settings.button_product.url %}
            {% endif %}

            <article class="{{ ns }}__card" {{ block.shopify_attributes }}>
              {% if block.settings.image != blank %}
                <div class="{{ ns }}__media">
                  <img
                    src="{{ block.settings.image | image_url: width: 600 }}"
                    srcset="{{ block.settings.image | image_url: width: 300 }} 300w, {{ block.settings.image | image_url: width: 600 }} 600w, {{ block.settings.image | image_url: width: 900 }} 900w"
                    sizes="(max-width: 989px) 90vw, 25vw"
                    alt="{{ block.settings.image.alt | escape }}"
                    loading="lazy">
                </div>
              {% endif %}

              {% if block.settings.heading != blank %}
                <h3 class="{{ ns }}__card-title">{{ block.settings.heading }}</h3>
              {% endif %}

              <div class="{{ ns }}__acc">
                {% for i in (1..4) %}
                  {% assign title_key = 'acc' | append: i | append: '_title' %}
                  {% assign body_key  = 'acc' | append: i | append: '_body' %}
                  {% assign t = block.settings[title_key] %}
                  {% assign b = block.settings[body_key] %}
                  {% if t != blank and b != blank %}
                    <details class="{{ ns }}__details">
                      <summary class="{{ ns }}__summary">
                        <span>{{ t }}</span>
                        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path d="M6 9l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                      </summary>
                      <div class="{{ ns }}__content rte">{{ b }}</div>
                    </details>
                  {% endif %}
                {% endfor %}
              </div>

              <div class="{{ ns }}__cta">
                <a class="{{ ns }}__btn" href="{{ link_url | default: '#' }}" {% if link_url == '' %}aria-disabled="true"{% endif %}>
                  {{ block.settings.button_text | default: 'Buy Now' }}
                </a>
              </div>
            </article>
          {% endfor %}
        </div>
      </div>

      <button class="{{ ns }}__arrow next" type="button" aria-label="Next" hidden>→</button>

      <!-- Mobile-only moving progress thumb -->
      <div class="nf-progress" aria-hidden="true"></div>
    </div>
  </div>

  <style>
    .{{ ns }}{
      padding:32px 0;
      background: {{ section.settings.background_color }};
      overflow-x: hidden; /* stop page-level x-bleed on mobile */
    }
    .{{ ns }}__inner{max-width:1300px;margin:0 auto;padding:0}
    .{{ ns }}__title{margin:0 0 16px;font-weight:500;line-height:1.6;font-size:30px;color:{{ section.settings.title_color }}}
    @media (max-width: 989px){
      .{{ ns }}__title{font-size:22px}
      .{{ ns }}{padding:32px 16px}
    }
    @media screen and (min-width: 990px) and (max-width: 1320px){
      .{{ ns }}__inner{
        padding-left: 20px;
        padding-right: 20px;
      }
    }

    /* ===== nf-progress (EXACT element): moving thumb like trending ===== */
    .{{ ns }} .nf-progress{
      display:none;
      height:4px; width:70px; border-radius:999px;
      background:#0f4264; /* match your trending bar */
      opacity:.9;
      transform:translateX(0);
      transition:transform 160ms linear;
      margin:12px 0 0;
    }
    @media (max-width: 989px){ .{{ ns }} .nf-progress{ display:block } }

    .{{ ns }}__shell{position:relative; --gap:16px}
    .{{ ns }}__viewport{overflow:hidden}
    .{{ ns }}__track{
      display:flex; gap:var(--gap);
      align-items:flex-start; /* accordion open doesn't force siblings taller */
      will-change: transform;
    }

    /* Desktop sizing: N columns */
    .{{ ns }}__shell{--cols: {{ section.settings.cols_desktop | default: 4 }}}
    .{{ ns }}__card{
      background:{{ section.settings.card_background_color }};
      border:1px solid {{ section.settings.card_border_color }};
      border-radius:12px; box-shadow:0 1px 2px rgba(0,0,0,.04);
      flex:0 0 calc((100% - (var(--cols) - 1)*var(--gap)) / var(--cols));
      min-width:240px;
      display:flex; flex-direction:column;
    }
    .{{ ns }}__media{padding:16px 16px 0}
    .{{ ns }}__media img{width:100%;height:200px;object-fit:contain;border-radius:8px;background:#f6f7f8}
    .{{ ns }}__card-title{padding:12px 16px;margin:0;font-size:20px;font-weight:500;line-height:1.6;color:{{ section.settings.card_title_color }}}

    .{{ ns }}__acc{padding:0 8px}
    .{{ ns }}__details{border-top:1px solid rgba(0,0,0,.08)}
    .{{ ns }}__summary{list-style:none;display:flex;justify-content:space-between;align-items:center;gap:8px;padding:10px 8px;cursor:pointer}
    .{{ ns }}__summary::-webkit-details-marker{display:none}
    .{{ ns }}__details[open] .{{ ns }}__summary svg{transform:rotate(180deg)}
    .{{ ns }}__content{padding:0 8px 10px;color:#444;font-size:13px}

    .{{ ns }}__cta{padding:12px 16px 16px}
    .{{ ns }}__btn{
      display:inline-flex;justify-content:center;align-items:center;width:100%;height:40px;border-radius:8px;
      background:{{ section.settings.card_button_bg_color }};color:{{ section.settings.card_button_color }};
      text-decoration:none;font-weight:600
    }
    .{{ ns }}__btn[aria-disabled="true"]{pointer-events:none;opacity:.5}

    /* Arrows (desktop) */
    .{{ ns }}__arrow{
      position:absolute;top:50%;transform:translateY(-50%);
      width:40px;height:40px;border-radius:50%;border:1px solid #0f4264;background:#0f4264;
      display:grid;place-items:center;box-shadow:0 2px 8px rgba(0,0,0,.08);
      cursor:pointer;color:#fff
    }
    .{{ ns }}__arrow.prev{left:-24px; z-index:1}
    .{{ ns }}__arrow.next{right:-24px; z-index:1}
    .{{ ns }}__arrow[hidden]{display:none}

    /* ===== Mobile: 1 card per slide, snap, NO overflow ===== */
    @media (max-width: 989px){
      .{{ ns }}__shell{--cols: {{ section.settings.cols_mobile | default: 1 }}}
      .{{ ns }}__viewport{
        overflow-x:auto; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch;
      }
      .{{ ns }}__track{ --gap:12px }
      .{{ ns }}__card{
        flex:0 0 calc(100% - var(--gap));
        min-width:calc(100% - var(--gap));
        scroll-snap-align:center;
      }
      .{{ ns }}__viewport::-webkit-scrollbar{height:0}
      .{{ ns }}__arrow{display:none}
    }
  </style>

  <script>
  (() => {
    const root = document.currentScript.closest('section.{{ ns }}');
    if (!root) return;

    const shell    = root.querySelector('.{{ ns }}__shell');
    const viewport = shell.querySelector('.{{ ns }}__viewport');
    const track    = shell.querySelector('.{{ ns }}__track');
    const cards    = [...track.children];
    const prevBtn  = shell.querySelector('.{{ ns }}__arrow.prev');
    const nextBtn  = shell.querySelector('.{{ ns }}__arrow.next');
    const nfThumb  = root.querySelector('.nf-progress'); // exact element

    const mqMobile = window.matchMedia('(max-width: 989px)');
    let colsDesktop = parseInt(shell.dataset.colsDesktop || '4', 10);
    let isMobile = mqMobile.matches;

    function cardWidth(){ return cards[0]?.getBoundingClientRect().width || 0; }
    function gap(){
      const g = getComputedStyle(track).gap || '16px';
      const n = parseFloat(g); return isFinite(n) ? n : 16;
    }
    function maxScroll(){ return Math.max(0, viewport.scrollWidth - viewport.clientWidth); }

    function updateArrows(){
      if (isMobile){
        prevBtn.hidden = true;
        nextBtn.hidden = true;
        return;
      }

      const need = cards.length > colsDesktop;
      if (!need){
        prevBtn.hidden = true;
        nextBtn.hidden = true;
        return;
      }

      const sl = viewport.scrollLeft;
      const mx = maxScroll();

      // Visibility rules:
      // - Hide prev when at start; show otherwise
      // - Hide next when at end; show otherwise
      prevBtn.hidden = sl <= 0;
      nextBtn.hidden = sl >= mx - 1;

      // We don't use visibility:hidden; if you prefer disabling instead,
      // you can also keep these for a11y feedback (optional):
      prevBtn.toggleAttribute('disabled', prevBtn.hidden);
      nextBtn.toggleAttribute('disabled', nextBtn.hidden);
    }

    function slide(dir){
      const step = cardWidth() + gap();
      viewport.scrollBy({ left: dir * step, behavior: 'smooth' });
    }

    /* ==== nf-progress: move thumb across VISIBLE viewport width ==== */
    function updateProgress(){
      if (!nfThumb) return;
      if (!isMobile){ nfThumb.style.transform = 'translateX(0px)'; return; }

      const mx = maxScroll();
      const ratio = mx > 0 ? (viewport.scrollLeft / mx) : 0;

      const viewW = viewport.clientWidth;        // travel across what user sees
      const barW  = nfThumb.offsetWidth || 70;
      const travel = Math.max(0, viewW - barW);
      nfThumb.style.transform = 'translateX(' + (ratio * travel) + 'px)';
    }

    function onResize(){
      isMobile = mqMobile.matches;
      colsDesktop = parseInt(shell.dataset.colsDesktop || '4', 10);
      updateArrows();
      updateProgress();
    }

    nextBtn?.addEventListener('click', () => slide(1));
    prevBtn?.addEventListener('click', () => slide(-1));
    viewport.addEventListener('scroll', () => { updateArrows(); updateProgress(); }, { passive:true });
    window.addEventListener('resize', onResize);
    mqMobile.addEventListener?.('change', onResize);

    // Recompute after images load
    track.querySelectorAll('img').forEach(img => {
      if (!img.complete) img.addEventListener('load', () => requestAnimationFrame(() => { updateArrows(); updateProgress(); }), { once:true });
    });

    // Initial state: prev hidden at start, next based on content width
    requestAnimationFrame(() => { updateArrows(); updateProgress(); });
  })();
</script>


  {% schema %}
  {
    "name": "Explore More (Cards)",
    "settings": [
      { "type": "text", "id": "title", "label": "Title", "default": "Explore More!" },
      { "type": "range", "id": "cols_desktop", "min": 1, "max": 6, "step": 1, "default": 4, "label": "Cards visible on desktop" },
      { "type": "color", "id": "background_color", "label": "Section background", "default": "#2c6191" },
      { "type": "color", "id": "title_color", "label": "Title color" },
      { "type": "color", "id": "card_title_color", "label": "Product Title color" },
      { "type": "color", "id": "card_background_color", "label": "Card background color" },
      { "type": "color", "id": "card_border_color", "label": "Card border color" },
      { "type": "color", "id": "card_button_color", "label": "Card button color" },
      { "type": "color", "id": "card_button_bg_color", "label": "Card button bg color" },
      { "type": "range", "id": "cols_mobile", "min": 1, "max": 3, "step": 1, "default": 1, "label": "Cards visible on mobile (recommended 1)" }
    ],
    "blocks": [
      {
        "type": "card",
        "name": "Card",
        "settings": [
          { "type": "image_picker", "id": "image", "label": "Image" },
          { "type": "text", "id": "heading", "label": "Title", "default": "Product title" },

          { "type": "text", "id": "acc1_title", "label": "Row 1 title", "default": "Who Am I?" },
          { "type": "richtext", "id": "acc1_body", "label": "Row 1 content", "default": "<p>Safe, stylish mealtime solution for babies.</p>" },

          { "type": "text", "id": "acc2_title", "label": "Row 2 title", "default": "Ideal For" },
          { "type": "richtext", "id": "acc2_body", "label": "Row 2 content", "default": "<p>Infants, toddlers, and parents on-the-go.</p>" },

          { "type": "text", "id": "acc3_title", "label": "Row 3 title", "default": "Colors Available" },
          { "type": "richtext", "id": "acc3_body", "label": "Row 3 content", "default": "<p>Grey, Sand, Blush</p>" },

          { "type": "text", "id": "acc4_title", "label": "Row 4 title", "default": "Price" },
          { "type": "richtext", "id": "acc4_body", "label": "Row 4 content", "default": "<p>₹1,999</p>" },

          { "type": "text", "id": "button_text", "label": "Button text", "default": "Buy Now" },
          { "type": "url", "id": "button_url", "label": "Button link (URL)" },
          { "type": "product", "id": "button_product", "label": "Or choose product (overrides URL if URL empty)" }
        ]
      }
    ],
    "max_blocks": 24,
    "presets": [
      { "name": "Explore More (Cards)", "category": "Custom" }
    ]
  }
  {% endschema %}
</section>
