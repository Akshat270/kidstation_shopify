{% assign ns = 'stl-' | append: section.id %}

<section class="{{ ns }}-section" data-section-id="{{ section.id }}">
  <div class="{{ ns }}-container">
    {% if section.settings.heading != blank %}
      <h2 class="{{ ns }}-heading">{{ section.settings.heading }}</h2>
    {% endif %}
    {% if section.settings.subheading != blank %}
      <p class="{{ ns }}-sub">{{ section.settings.subheading }}</p>
    {% endif %}

    <!-- Left big, middle (top/bottom), right big -->
    <div class="{{ ns }}-grid" style="--rowH: {{ section.settings.row_height | default: 320 }}px">
      {% for block in section.blocks %}
        {% assign pos = '' %}
        {% case forloop.index %}
          {% when 1 %}{% assign pos = 'pos-left' %}
          {% when 2 %}{% assign pos = 'pos-mid-top' %}
          {% when 3 %}{% assign pos = 'pos-mid-bottom' %}
          {% when 4 %}{% assign pos = 'pos-right' %}
        {% endcase %}

        <div class="{{ ns }}-tile {{ ns }}-{{ pos }}" {{ block.shopify_attributes }}>
          <div class="{{ ns }}-media">
            {% if block.settings.image %}
              <img class="{{ ns }}-img"
                   src="{{ block.settings.image | image_url: width: 1600 }}"
                   alt="{{ block.settings.alt | escape }}" loading="lazy">
            {% else %}
              <div class="{{ ns }}-placeholder">Upload an image</div>
            {% endif %}

            {%- comment -%}
              HOTSPOTS (forced): render each enabled slot 1..6.
              Resolve product if provided; popup opens even if none (disabled style).
            {%- endcomment -%}
            {% for i in (1..6) %}
              {% capture e %}spot{{ i }}_enable{% endcapture %}
              {% capture pr %}spot{{ i }}_product{% endcapture %}
              {% capture xx %}spot{{ i }}_x{% endcapture %}
              {% capture yy %}spot{{ i }}_y{% endcapture %}
              {% if block.settings[e] %}
                {%- assign raw = block.settings[pr] -%}
                {%- assign handle = raw.handle | default: raw -%}
                {%- assign prod = all_products[handle] | default: raw -%}
                <div class="{{ ns }}-hotspot" style="--x: {{ block.settings[xx] }}%; --y: {{ block.settings[yy] }}%;" data-hotspot>
                  <button class="{{ ns }}-pin" type="button" aria-expanded="false" aria-label="{% if prod %}View {{ prod.title | escape }}{% else %}Assign a product{% endif %}">
                    <svg width="22" height="22" viewBox="0 0 28 28" aria-hidden="true">
                      <circle cx="14" cy="14" r="13" fill="white"></circle>
                      <path d="M14 7v14M7 14h14" stroke="black" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                  </button>

                  {% if prod %}
                    <a href="{{ prod.url }}" class="{{ ns }}-popover" tabindex="-1" data-popover role="dialog" aria-label="{{ prod.title | escape }}" style="--shift-x:0px;">
                      <div class="{{ ns }}-pop-inner">
                        {% if prod.featured_image %}
                          <img class="{{ ns }}-pop-img" src="{{ prod.featured_image | image_url: width: 200, height: 200, crop: 'center' }}" alt="{{ prod.title | escape }}" loading="lazy">
                        {% endif %}
                        <div class="{{ ns }}-pop-meta">
                          <div class="{{ ns }}-pop-title">{{ prod.title }}</div>
                          <div class="{{ ns }}-pop-price">{{ prod.price_min | money }}</div>
                        </div>
                      </div>
                    </a>
                  {% else %}
                    <div class="{{ ns }}-popover {{ ns }}-popover--disabled" data-popover role="dialog" aria-label="Assign a product" style="--shift-x:0px;">
                      <div class="{{ ns }}-pop-inner">
                        <div class="{{ ns }}-pop-img {{ ns }}-pop-img--ph"></div>
                        <div class="{{ ns }}-pop-meta">
                          <div class="{{ ns }}-pop-title">Assign a product</div>
                          <div class="{{ ns }}-pop-price">â€”</div>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                </div>
              {% endif %}
            {% endfor %}

          </div>
        </div>
      {% endfor %}
    </div>
  </div>

<style>
  .{{ ns }}-section{padding:36px 0; overflow-x:hidden}
  .{{ ns }}-container{max-width:1300px;margin:0 auto;padding:0;}
  .{{ ns }}-heading{margin:0 0 8px;font-size:clamp(22px,2.6vw,30px);line-height:1.2}
  .{{ ns }}-sub{margin:0 0 24px;color:#000;max-width:900px;font-size:17px;}

  /* Desktop layout */
  .{{ ns }}-grid{
    display:grid;
    grid-template-columns:1.25fr 1fr 1.25fr;
    grid-template-rows:repeat(2,var(--rowH,320px));
    gap:22px
  }
  .{{ ns }}-tile{position:relative}
  .{{ ns }}-pos-left{grid-column:1;grid-row:1 / span 2}
  .{{ ns }}-pos-mid-top{grid-column:2;grid-row:1}
  .{{ ns }}-pos-mid-bottom{grid-column:2;grid-row:2}
  .{{ ns }}-pos-right{grid-column:3;grid-row:1 / span 2}

  /* Mobile: stack */
  @media (max-width:989px){
    .{{ ns }}-grid{grid-template-columns:1fr;grid-template-rows:none}
    .{{ ns }}-tile{grid-column:auto;grid-row:auto}
    .{{ ns }}-container{padding:0 20px}
    .{{ ns }}-sub{font-size:14px !important;line-height:1.8}
    .{{ ns }}-hotspot{z-index:unset !important;}
    .{{ ns }}-section{padding-top:0;padding-bottom:36px;padding-left:0;padding-right:0;}
  }

  /* MEDIA CARD */
  .{{ ns }}-media{
    position:relative;width:100%;height:100%;
    border-radius:14px;overflow:visible;background:#f6f7f8
  }
  .{{ ns }}-img{width:100%;height:100%;object-fit:cover;display:block;border-radius:14px}
  .{{ ns }}-placeholder{width:100%;height:100%;display:grid;place-items:center;color:#999}

  /* HOTSPOTS */
  .{{ ns }}-hotspot{
    position:absolute !important;
    left:var(--x) !important; top:var(--y) !important;
    transform:translate(-50%,-50%) !important;
    display:block !important; pointer-events:auto !important
  }

  /* Pin */
  .{{ ns }}-pin{
    width:28px;height:28px;border-radius:999px;
    display:grid;place-items:center;border:1px solid rgba(0,0,0,.15);
    background:#fff; cursor:pointer;
    padding-left:0;padding-right:0;
    box-shadow:0 6px 16px rgba(0,0,0,.2) !important;
    transition:transform .18s ease; position:relative; z-index:2 !important
  }
  .{{ ns }}-pin:hover{transform:scale(1.06)}
  .{{ ns }}-pin:focus-visible{outline:2px solid #111;outline-offset:2px}
  .{{ ns }}-pin::after{
    content:""; position:absolute; inset:-6px; border-radius:999px; pointer-events:none;
    animation: {{ ns }}-pulse 1.4s ease-out infinite;
    box-shadow:0 0 0 0 rgba(0,0,0,.18);
  }
  @keyframes {{ ns }}-pulse{
    0%{box-shadow:0 0 0 0 rgba(0,0,0,.18)}
    70%{box-shadow:0 0 0 10px rgba(0,0,0,0)}
    100%{box-shadow:0 0 0 0 rgba(0,0,0,0)}
  }
  @media (max-width:749px){ .{{ ns }}-pin{width:30px;height:30px} }

  /* POPOVER (desktop defaults: positioned near pin) */
  .{{ ns }}-popover{
    position:absolute !important;
    min-width:220px; max-width:260px;
    background:#fff;border-radius:12px;
    box-shadow:0 12px 28px rgba(0,0,0,.2);
    text-decoration:none;color:inherit;
    opacity:0;visibility:hidden;pointer-events:none;
    z-index:10000 !important;
    transition:opacity .16s ease,visibility .16s ease,transform .16s ease
  }
  .{{ ns }}-popover.is-open{opacity:1;visibility:visible;pointer-events:auto}

  .{{ ns }}-popover--disabled .{{ ns }}-pop-title{opacity:.7}

  .{{ ns }}-pop-inner{display:grid;grid-template-columns:72px 1fr;gap:10px;padding:10px}
  .{{ ns }}-pop-img{width:72px;height:72px;object-fit:cover;border-radius:10px;background:#f3f3f3}
  .{{ ns }}-pop-meta{display:flex;flex-direction:column;gap:6px;align-self:center}
  .{{ ns }}-pop-title{font-size:13px;line-height:1.3;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;overflow:hidden;max-height:calc(1.3em*2)}
  .{{ ns }}-pop-price{font-weight:600;font-size:13px}

  /* MOBILE: center inside the image (JS moves popover under .{{ ns }}-media) */
  @media (max-width:989px){
    .{{ ns }}-media > .{{ ns }}-popover.is-mobile-center{
      position:absolute !important;
      left:50% !important;
      top:50% !important;
      transform:translate(-50%, -50%) !important;
      width:auto !important;
      max-width:min(420px, 92%) !important; /* keep inside image */
      z-index:10000 !important;
    }
  }
</style>
<script>
(function(){
  var root = document.querySelector('.{{ ns }}-section'); if(!root) return;
  var openPop = null;

  function closePop(){
    if(!openPop) return;

    // if we moved the popover into the media on mobile, put it back into its host
    if (openPop.__origParent && openPop.__placeholder) {
      openPop.__origParent.insertBefore(openPop, openPop.__placeholder);
      openPop.__placeholder.remove();
    }

    openPop.classList.remove('is-open','place-top','place-right','place-left','place-bottom','is-mobile-center');
    openPop.style.left = openPop.style.top = openPop.style.right = openPop.style.transform = '';
    openPop.style.position = ''; openPop.style.maxWidth = '';
    delete openPop.__origParent; delete openPop.__placeholder;

    var pin = root.querySelector('.{{ ns }}-pin[aria-expanded="true"]');
    if(pin) pin.setAttribute('aria-expanded','false');

    openPop = null;
  }

  // Position popover: desktop = near pin; mobile = center of image
  function positionPopover(host, pop){
    pop.classList.remove('place-top','place-right','place-left','place-bottom','is-mobile-center');
    pop.style.left = pop.style.top = pop.style.right = '';
    pop.style.transform = ''; pop.style.position = ''; pop.style.maxWidth = '';

    var media = host.closest('.{{ ns }}-media'); if(!media) return;

    // Always open to measure
    pop.classList.add('is-open');

    /* ===== MOBILE: center inside image ===== */
    if (window.matchMedia('(max-width: 989px)').matches) {
      // move the popover under the media so absolute coords are relative to the image
      if (!pop.__origParent) {
        pop.__origParent = pop.parentNode;
        pop.__placeholder = document.createComment('popover-placeholder');
        pop.__origParent.insertBefore(pop.__placeholder, pop);
        media.appendChild(pop);
      }

      // set centered style via class (CSS handles the translate)
      pop.classList.add('is-mobile-center');

      // ensure it fits inside image width nicely
      var mr = media.getBoundingClientRect();
      var maxW = Math.min(420, mr.width - 24); // 12px padding each side
      pop.style.maxWidth = maxW + 'px';

      return; // done for mobile
    }

    /* ===== DESKTOP/TABLET: original placement around pin ===== */
    var mr = media.getBoundingClientRect();
    var hr = host.getBoundingClientRect();
    var pr = pop.getBoundingClientRect();
    var margin = 12;

    var topSpace    = hr.top    - mr.top;
    var rightSpace  = mr.right  - hr.right;
    var bottomSpace = mr.bottom - hr.bottom;
    var leftSpace   = hr.left   - mr.left;

    var placement = 'top';
    if (pr.height + margin <= topSpace) placement = 'top';
    else if (pr.width + margin <= rightSpace) placement = 'right';
    else if (pr.width + margin <= leftSpace) placement = 'left';
    else placement = 'bottom';

    var x = hr.left - mr.left, y = hr.top - mr.top;
    var pinW = hr.width || 24, pinH = hr.height || 24;

    var leftPx, topPx;
    if (placement === 'top')   { leftPx = (x + pinW/2) - pr.width/2; topPx = y - margin - pr.height; pop.classList.add('place-top'); }
    else if (placement === 'right'){ leftPx = x + pinW + margin; topPx = y + pinH/2 - pr.height/2; pop.classList.add('place-right'); }
    else if (placement === 'left') { leftPx = x - margin - pr.width; topPx = y + pinH/2 - pr.height/2; pop.classList.add('place-left'); }
    else                         { leftPx = (x + pinW/2) - pr.width/2; topPx = y + pinH + margin; pop.classList.add('place-bottom'); }

    // clamp inside media
    if (leftPx < 0) leftPx = 0;
    if (leftPx + pr.width > mr.width) leftPx = mr.width - pr.width;
    if (topPx < 0) topPx = 0;
    if (topPx + pr.height > mr.height) topPx = mr.height - pr.height;

    // convert to host-relative (popover is inside host)
    var finalLeft = leftPx - (hr.left - mr.left);
    var finalTop  = topPx  - (hr.top  - mr.top);

    pop.style.left = finalLeft + 'px';
    pop.style.top  = finalTop  + 'px';
  }

  function toggle(pin){
    var host = pin.closest('[data-hotspot]');
    var pop  = host?.querySelector('[data-popover]');
    if(!pop) return;

    if(openPop === pop){ closePop(); return; }
    closePop();

    positionPopover(host, pop);
    pop.classList.add('is-open');
    pin.setAttribute('aria-expanded','true');
    openPop = pop;
  }

  // Auto-open first valid popover
  function autoOpenFirstInFirstTile(){
    var firstTile = root.querySelector('.{{ ns }}-tile');
    if(!firstTile) return;
    var host = firstTile.querySelector('[data-hotspot]');
    var pop  = firstTile.querySelector('[data-popover]:not(.{{ ns }}-popover--disabled)');
    if(host && pop){
      positionPopover(host, pop);
      pop.classList.add('is-open');
      pop.dataset.autopen = '1';
      var pin = host.querySelector('.{{ ns }}-pin');
      if(pin) pin.setAttribute('aria-expanded','true');
      openPop = pop;
    }
  }

  function repositionAutoOpened(){
    var pop = root.querySelector('[data-popover].is-open[data-autopen="1"]');
    if(!pop) return;
    var host = pop.__origParent ? pop.__origParent.closest('[data-hotspot]') : pop.closest('[data-hotspot]');
    if(!host) return;
    positionPopover(host, pop);
  }

  // events
  var lastToggleTs = 0;
  function throttleTap(){ var now = Date.now(); if (now - lastToggleTs < 120) return false; lastToggleTs = now; return true; }

  root.addEventListener('click', function(e){
    var pin = e.target.closest('.{{ ns }}-pin'); if(!pin || !root.contains(pin)) return;
    e.preventDefault(); if (!throttleTap()) return; toggle(pin);
  });

  root.addEventListener('pointerup', function(e){
    var pin = e.target.closest('.{{ ns }}-pin'); if(!pin || !root.contains(pin)) return;
    if (!throttleTap()) return; toggle(pin);
  });

  root.addEventListener('keydown', function(e){
    var pin = e.target.closest('.{{ ns }}-pin'); if(!pin) return;
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); if (!throttleTap()) return; toggle(pin); }
  });

  document.addEventListener('click', function(e){ if(!root.contains(e.target)) closePop(); });
  document.addEventListener('keydown', function(e){ if(e.key === 'Escape') closePop(); });

  window.addEventListener('load', autoOpenFirstInFirstTile);
  requestAnimationFrame(autoOpenFirstInFirstTile);
  window.addEventListener('resize', function(){
    clearTimeout(window.__stlResizeTO);
    window.__stlResizeTO = setTimeout(repositionAutoOpened, 120);
  }, { passive: true });
})();
</script>



</section>

{% schema %}
{
  "name": "Shop Look",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Shop The Look" },
    { "type": "textarea", "id": "subheading", "label": "Subheading", "default": "Introduce your collection here." },
    { "type": "range", "id": "row_height", "label": "Row height (desktop)", "min": 260, "max": 420, "step": 10, "default": 320 }
  ],
  "blocks": [
    {
      "type": "tile",
      "name": "Tile",
      "settings": [
        { "type": "image_picker", "id": "image", "label": "Image" },
        { "type": "text", "id": "alt", "label": "Alt text" },

        { "type": "header", "content": "Hotspot 1" },
        { "type": "checkbox", "id": "spot1_enable", "label": "Enable", "default": false },
        { "type": "product", "id": "spot1_product", "label": "Product" },
        { "type": "range", "id": "spot1_x", "label": "X (%)", "min": 0, "max": 100, "step": 1, "default": 30 },
        { "type": "range", "id": "spot1_y", "label": "Y (%)", "min": 0, "max": 100, "step": 1, "default": 30 },

        { "type": "header", "content": "Hotspot 2" },
        { "type": "checkbox", "id": "spot2_enable", "label": "Enable", "default": false },
        { "type": "product", "id": "spot2_product", "label": "Product" },
        { "type": "range", "id": "spot2_x", "label": "X (%)", "min": 0, "max": 100, "step": 1, "default": 60 },
        { "type": "range", "id": "spot2_y", "label": "Y (%)", "min": 0, "max": 100, "step": 1, "default": 60 },

        { "type": "header", "content": "Hotspot 3" },
        { "type": "checkbox", "id": "spot3_enable", "label": "Enable", "default": false },
        { "type": "product", "id": "spot3_product", "label": "Product" },
        { "type": "range", "id": "spot3_x", "label": "X (%)", "min": 0, "max": 100, "step": 1, "default": 45 },
        { "type": "range", "id": "spot3_y", "label": "Y (%)", "min": 0, "max": 100, "step": 1, "default": 45 },

        { "type": "header", "content": "Hotspot 4" },
        { "type": "checkbox", "id": "spot4_enable", "label": "Enable", "default": false },
        { "type": "product", "id": "spot4_product", "label": "Product" },
        { "type": "range", "id": "spot4_x", "label": "X (%)", "min": 0, "max": 100, "step": 1, "default": 20 },
        { "type": "range", "id": "spot4_y", "label": "Y (%)", "min": 0, "max": 100, "step": 1, "default": 80 },

        { "type": "header", "content": "Hotspot 5" },
        { "type": "checkbox", "id": "spot5_enable", "label": "Enable", "default": false },
        { "type": "product", "id": "spot5_product", "label": "Product" },
        { "type": "range", "id": "spot5_x", "label": "X (%)", "min": 0, "max": 100, "step": 1, "default": 80 },
        { "type": "range", "id": "spot5_y", "label": "Y (%)", "min": 0, "max": 100, "step": 1, "default": 20 },

        { "type": "header", "content": "Hotspot 6" },
        { "type": "checkbox", "id": "spot6_enable", "label": "Enable", "default": false },
        { "type": "product", "id": "spot6_product", "label": "Product" },
        { "type": "range", "id": "spot6_x", "label": "X (%)", "min": 0, "max": 100, "step": 1, "default": 50 },
        { "type": "range", "id": "spot6_y", "label": "Y (%)", "min": 0, "max": 100, "step": 1, "default": 50 }
      ]
    }
  ],
  "max_blocks": 4,
  "presets": [
    {
      "name": "Shop Look",
      "blocks": [
        { "type": "tile", "settings": { "spot1_enable": true, "spot1_x": 52, "spot1_y": 15, "spot2_enable": true, "spot2_x": 87, "spot2_y": 84, "spot3_enable": true, "spot3_x": 47, "spot3_y": 44, "spot4_enable": true, "spot4_x": 22, "spot4_y": 80 } },
        { "type": "tile", "settings": { "spot1_enable": true, "spot1_x": 30, "spot1_y": 30, "spot2_enable": true, "spot2_x": 79, "spot2_y": 78 } },
        { "type": "tile", "settings": { "spot1_enable": true, "spot1_x": 30, "spot1_y": 30, "spot2_enable": true, "spot2_x": 71, "spot2_y": 68, "spot3_enable": true, "spot3_x": 45, "spot3_y": 56 } },
        { "type": "tile", "settings": { "spot1_enable": true, "spot1_x": 18, "spot1_y": 29, "spot2_enable": true, "spot2_x": 39, "spot2_y": 55 } }
      ]
    }
  ]
}
{% endschema %}
